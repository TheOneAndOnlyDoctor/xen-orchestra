#!/bin/sh

set -eu

# compute the list of staged files we are interrested in
set --
buf=$(mktemp -u)
git diff-index --cached --diff-filter=AM --name-only HEAD > "$buf"
while IFS= read -r file
do
  case "$file" in
    *.js)
      set -- "$@" "$file";;
  esac
done < "$buf"

if [ $# -eq 0 ]
then
  exit
fi

# save unstaged changes
if ! git diff-files --binary --exit-code --no-color --no-ext-diff "$@" > .git/lint-staged.diff
then
  # remove them from the worktree
  git checkout "$@"

  # re-apply them on exit
  on_exit () {
    git apply --whitespace=nowarn .git/lint-staged.diff
    rm -f .git/lint-staged.diff
  }
  trap on_exit EXIT
fi

#  run commands
eslint --fix "$@"
jest --findRelatedTests --passWithNoTests "$@"

# add any changes made by the commands
git add "$@"
